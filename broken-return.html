<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Broken Product Return - ReTrack</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@2.0.0/dist/tf.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body {
      background-color: #f9fafa;
      color: #1f2937;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 20px;
    }
    h1 { font-size: 2.2rem; font-weight: 600; margin-bottom: 10px; }
    p.subtitle { font-size: 1.1rem; margin-bottom: 25px; color: #4b5563; }
    .upload-container {
      display: flex; flex-direction: column; gap: 15px;
      margin-bottom: 30px; width: 100%; max-width: 400px;
    }
    input[type="file"], button {
      padding: 12px; font-size: 1rem; border-radius: 8px; width: 100%;
    }
    input[type="file"] { border: 1px solid #d1d5db; }
    button {
      background-color: #10b981; color: white; border: none; cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover { background-color: #059669; }
    #preview {
      margin-top: 20px; max-width: 300px;
      border-radius: 10px; border: 2px solid #e5e7eb; display: none;
    }
    .output p { font-size: 1.1rem; margin: 5px 0; }
    #status { margin-top: 15px; font-size: 0.95rem; color: #6b7280; }
    .dashboard-link {
      margin-top: 30px; font-size: 1rem;
      color: #2563eb; text-decoration: none;
    }
    .dashboard-link:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <h1>ReTrack</h1>
  <p class="subtitle">Upload image of damaged product to classify</p>
  <div class="upload-container">
    <input type="file" id="imageInput" accept="image/*" style="display: none;" />
    <button onclick="document.getElementById('imageInput').click()">Upload from Gallery</button>
    <button onclick="classify()">Classify Image</button>
    <button onclick="startCamera()">üì∏ Use Camera</button>
    <video id="camera" autoplay playsinline width="300" style="display:none; border-radius: 8px; border: 2px solid #ccc;"></video>
    <button onclick="captureFromCamera()" id="captureBtn" style="display:none;">Capture</button>
    <canvas id="canvas" style="display:none;"></canvas>
  </div>
  <img id="preview" alt="Image Preview" />
  <div class="output">
    <p id="result"></p>
    <p id="confidence"></p>
    <p id="status">Status: Ready</p>
  </div>
  <a href="return.html" class="dashboard-link">‚Üê Go Back</a>

  <script>
    let model;
    let videoStream;
    async function loadModel() {
      try {
        const modelURL = 'https://raw.githubusercontent.com/SmaranNadig/retrack-website/main/model/model.json';
        model = await tf.loadLayersModel(modelURL);
        document.getElementById('status').innerText = 'Status: Model loaded ‚úÖ';
      } catch (error) {
        document.getElementById('status').innerText = `Model load error ‚ùå: ${error.message}`;
      }
    }
    loadModel();

    async function classify() {
      const fileInput = document.getElementById('imageInput');
      const img = document.getElementById('preview');
      if (!fileInput.files[0]) return alert('Upload an image first.');

      img.src = URL.createObjectURL(fileInput.files[0]);
      img.style.display = 'block';
      document.getElementById('status').innerText = 'Classifying...';

      img.onload = async () => {
        try {
          const tensor = tf.browser.fromPixels(img)
            .resizeBilinear([224, 224]).div(255.0).expandDims(0);
          const prediction = await model.predict(tensor).data();
          const labels = ['Exchange', 'Return'];
          const maxIndex = prediction.indexOf(Math.max(...prediction));
          const result = labels[maxIndex];
          const confidence = prediction[maxIndex];

          document.getElementById('result').innerText = `üßæ Result: ${result}`;
          document.getElementById('confidence').innerText = `üìä Confidence: ${(confidence * 100).toFixed(2)}%`;
          document.getElementById('status').innerText = 'Classification complete ‚úÖ';

          sendToThingSpeak(result, confidence, 'uploaded-image');
        } catch (error) {
          document.getElementById('status').innerText = `Error: ${error.message}`;
        }
      };
    }

    function sendToThingSpeak(result, confidence, source) {
      const url = `https://api.thingspeak.com/update?api_key=ORZJ88EUT7HLBIQC&field5=${result}&field6=${confidence}&status=${source}`;
      fetch(url).then(r => r.ok ? console.log('Sent to ThingSpeak') : console.warn('Error'));
    }

    function startCamera() {
      const video = document.getElementById('camera');
      navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then(stream => {
          video.srcObject = stream;
          videoStream = stream;
          video.style.display = 'block';
          document.getElementById('captureBtn').style.display = 'inline-block';
          document.getElementById('status').innerText = 'Camera active üé•';
        });
    }

    async function captureFromCamera() {
      const video = document.getElementById('camera');
      const canvas = document.getElementById('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);

      const preview = document.getElementById('preview');
      preview.src = canvas.toDataURL('image/jpeg');
      preview.style.display = 'block';

      const tensor = tf.browser.fromPixels(canvas)
        .resizeBilinear([224, 224]).div(255.0).expandDims(0);

      const prediction = await model.predict(tensor).data();
      const labels = ['Exchange', 'Return'];
      const maxIndex = prediction.indexOf(Math.max(...prediction));
      const result = labels[maxIndex];
      const confidence = prediction[maxIndex];

      document.getElementById('result').innerText = `üßæ Result: ${result}`;
      document.getElementById('confidence').innerText = `üìä Confidence: ${(confidence * 100).toFixed(2)}%`;
      document.getElementById('status').innerText = 'Classification complete ‚úÖ';

      sendToThingSpeak(result, confidence, 'camera-image');
    }
  </script>
</body>
</html>
